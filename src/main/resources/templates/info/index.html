<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="css/vision-x.css" type="text/css">
  <link rel="stylesheet" href="css/service.css" type="text/css">
  <link rel="stylesheet" href="css/xdk.css" type="text/css">
  <link rel="stylesheet" href="css/news.css" type="text/css">
  <link rel="stylesheet" href="css/popup.css" type="text/css">

  <link rel="stylesheet" href="css/core.css" type="text/css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Alata&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Alata&family=Anek+Latin:wght@100..800&display=swap"
    rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="/assets/vendor/libs/sha512/sha512.min.js"></script>

  <script src="/js/ui_vision-x.js"></script>
  <script src="/js/popup.js"></script>
  <title>Vision-X</title>
</head>

<body>
  <div id="contact_popup"></div>
  <div id="signIn_popup"></div>
  <div id="signUp_popup"></div>

  <nav class="top-nav">
    <div class="sub-menu">
      <ul class="d-fl gap-25 sub-nav">
        <li th:if="${#httpServletRequest.remoteUser != null}">
          <span th:text="${#httpServletRequest.remoteUser}"></span>
        </li>
        <li th:if="${#httpServletRequest.remoteUser != null}">
          <form th:action="@{/logout}" method="post">
            <button type="submit" class="logout-btn">Logout</button>
          </form>
        </li>
        <li th:if="${#httpServletRequest.remoteUser != null}">
          <button class="redirect-btn" onclick="redirectToOtherDomain()">Go to EgisCloud</button>
        </li>


        <li th:if="${#httpServletRequest.remoteUser == null}" class="sign-up-btn">
          Sign up
        </li>
        <li th:if="${#httpServletRequest.remoteUser == null}" class="sign-in-btn">
          Sign in
        </li>
        <li class="lang active">EN</li>
        <li class="lang">KR</li>
      </ul>
    </div>
    <div class="wrap-top">
      <a href="home.html" class="logo main"><i></i></a>
      <div class="navigation">
        <a href="home.html" class="home main">Home</a>
        <a href="home.html" class="about-us main">About us</a>
        <a href="service.html" class="menu-item service">Service</a>
        <a href="xdk.html" class="menu-item xdk">XDK</a>
        <a href="news.html" class="menu-item news">News</a>
        <button class="contact-btn">Get in Contact</button>
      </div>
      <button class="mobile-menu"></button>
    </div>
    <div class="m-navigation hide">
      <div class="sign-up-btn">Sign up</div>
      <div class="sign-in-btn">Sign in</div>
      <a href="home.html" class="home main">Home</a>
      <a href="home.html" class="about-us main">About us</a>
      <a href="service.html" class="service">Service</a>
      <a href="xdk.html" class="xdk">XDK</a>
      <a href="news.html" class="news">News</a>
      <button class="contact-btn">Get in Contact</button>
      <div class="popup-close m-nav-close">X</div>
    </div>
  </nav>

  <div id="content-area">

  </div>

  <div class="footer">
    <ul>
      <li class="provied">Provided by</li>
      <li class="base-x"></li>
      <li class="gaia-x"></li>
      <li class="dlr"></li>
      <li class="daegu-logo"></li>
    </ul>
    <span>Copyright @ EGIS 2024. All Rights Reserved.</span>
  </div>

  <script>
    $(document).ready(function () {
      const contactOpenPopup = $("#contact_popup");
      contactOpenPopup.hide();
      contactOpenPopup.load("popup/contact_pop.html", function () {
        if (typeof initContactPopup === 'function') {
          initContactPopup();
        } else {
          console.error('initContactPopup is not defined!');
        }
      });

      const SignUpOpenPopup = $("#signUp_popup");
      SignUpOpenPopup.hide();
      SignUpOpenPopup.load("popup/sign_up_pop.html", function () {
        if (typeof initSignUpPopup === 'function') {
          initSignUpPopup();
        } else {
          console.error('initSignUpPopup is not defined!');
        }
      });

      const SignInOpenPopup = $("#signIn_popup");
      SignInOpenPopup.hide();
      SignInOpenPopup.load("popup/sign_in_pop.html", function () {
        if (typeof initSignInPopup === 'function') {
          initSignInPopup();
        } else {
          console.error('initSignInPopup is not defined!');
        }
      });
    });
    $(document).on('ready', function() {
      setTimeout(function() {
        $(document).scrollTop(0);
      3}, 0);
    });
    function loginAndRedirect() {

      // 로그인 폼의 데이터를 가져옵니다
      const memId = localStorage.getItem("memId");
      const hashedPwd = localStorage.getItem("hashedPwd");


      // 유효성 검사: 아이디와 비밀번호 입력 확인
      if (memId === "") {
        alert("아이디를 입력하세요.");
        document.getElementById("memId").focus();
        return;
      }
      if (memPwd === "") {
        alert("비밀번호를 입력하세요.");
        document.getElementById("memPwd").focus();
        return;
      }


      // 로그인 정보를 포함한 폼 데이터를 생성합니다.
      const formData = new FormData();
      formData.append("memId", memId);
      formData.append("memPwd", hashedPwd);

      // test.vision-x.kr의 로그인 엔드포인트로 POST 요청을 보냅니다.
      fetch("https://test.vision-x.kr/member/checkLogin.do", {
        method: "POST",
        body: formData,
        credentials: "include" // 쿠키를 포함해서 요청 (세션 유지)
      })
              .then(response => response.json())
              .then(data => {
                if (data.MEM_INFO && data.MEM_INFO !== "NONE") {
                  if (data.MEM_INFO.LOGIN_COUNT >= 5) {
                    // 로그인 5회 실패 시 경고 처리
                    alert("로그인 5회 실패로 인한 비밀번호 초기화가 필요합니다.");
                    $("#errorPwdPopup").addClass("active");
                    // 비밀번호 초기화 팝업을 표시하는 로직 추가 가능
                    return;
                  } else if (data.MEM_INFO.MEM_LEVEL === 0) {
                    // 비허가 사용자 처리
                    alert("비허가 사용자입니다.");
                    return;
                  } else if (data.MEM_INFO.MEM_LEVEL === -1) {
                    // 이메일 미인증 사용자 처리
                    alert("이메일 미인증 사용자입니다. 이메일을 인증해 주세요.");
                    return;
                  } else {
                    // 로그인 성공 시 쿠키 설정 및 페이지 이동 처리
                    if (data.key != null && data.key !== "{}") {
                      setCookie("keyCookie", data.key, 1);
                    }
                    checkCookie(); // 아이디 저장 여부에 따른 쿠키 설정

                    // OTP 사용 여부 확인 후 처리
                    if (data.otp_flag === "1") {
                      // OTP 인증이 필요한 경우
                      $('#otp-modal').modal('show');
                      $('#otpCreate').click();
                    } else {
                      // OTP 없이 로그인 성공
                      loginSession();
                    }
                  }
                } else {
                  // 로그인 실패 처리
                  alert("로그인 실패: 아이디나 비밀번호가 잘못되었습니다.");
                }
              })
              .catch(error => {
                console.error("Error during login:", error);
              });
    }

    // 로그인 세션 유지 함수
    function loginSession() {
      const memId = localStorage.getItem("memId");
      const hashedPwd = localStorage.getItem("hashedPwd");

      const formData = new FormData();
      formData.append("memId", memId);
      formData.append("memPwd", hashedPwd);
      formData.append("lang", "ko");

      fetch("https://test.vision-x.kr/member/loginSession.do", {
        method: "POST",
        body: formData,
        credentials: "include"
      })
              .then(response => response.json())
              .then(result => {
                if (result.MEM_INFO === "fail") {
                  alert("OTP 인증에 실패하였습니다. 다시 시도해 주세요.");
                  $('#optNum').focus();
                  return;
                }
                const loginResult = result.MEM_INFO.MEM_LEVEL;
                if (loginResult === 10) {
                  // 관리자 로그인 성공 시 관리자 페이지로 리다이렉트
                  location.href = "../ide.do";
                } else if ([1, 5, 10].includes(loginResult)) {
                  // 일반 회원 로그인 성공 시
                  const timediff = result.timediff;
                  const tempPwd = result.MEM_INFO.TEMP_PWD_FLAG;
                  if (parseInt(timediff) >= 3 || parseInt(tempPwd) > 0) {
                    location.href = "//" + window.location.host + "/desk/moveChgPWD.do";
                  } else {
                    if (location.href.indexOf("main.do") > -1) {
                      location.reload();
                    } else {
                      location.href = "//" + window.location.host + "";
                    }
                  }
                }
              })
              .catch(error => {
                console.error("Error during login session:", error);
              });
    }

    // 쿠키 설정 함수
    function setCookie(cookieName, value, exdays) {
      const exdate = new Date();
      exdate.setDate(exdate.getDate() + exdays);
      const cookieValue = escape(value) + ((exdays == null) ? "" : "; path=/; expires=" + exdate.toGMTString());
      document.cookie = cookieName + "=" + cookieValue;
    }

    // 아이디 저장 체크박스 처리 함수
    function checkCookie() {
      if ($("#idSetCookie").is(":checked")) {
        const memId = $("#memId").val();
        setCookie("memId", memId, 60);
        setCookie("checkCookie", "Y", 60);
      } else {
        deleteCookie("memId");
        deleteCookie("checkCookie");
      }
    }

    function deleteCookie(cookieName) {
      const expireDate = new Date();
      expireDate.setDate(expireDate.getDate() - 1);
      document.cookie = cookieName + "=; expires=" + expireDate.toGMTString() + "; path=/";
    }

    function redirectToOtherDomain() {
      loginAndRedirect();
    }
  </script>
</body>

</html>